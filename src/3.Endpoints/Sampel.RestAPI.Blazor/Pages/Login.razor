@page "/login"
@layout AuthLayout
@using Sampel.RestAPI.Blazor.Authentication
@using MudBlazor
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>ورود به سیستم</PageTitle>
<link href="css/login.css" rel="stylesheet" />

<div class="login-container-modern">
    <div class="login-background-animation"></div>
    <div class="login-particles"></div>
    
    <div class="login-wrapper">
        <!-- Enhanced Hero Section -->
        <div class="login-hero-section">
            <div class="hero-content-modern">
                <div class="hero-icon-container">
                    <div class="hero-icon-wrapper">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Class="hero-main-icon" />
                        <div class="hero-icon-glow"></div>
                    </div>
                </div>
                
                <div class="hero-text-section">
                    <MudText Typo="Typo.h3" Class="hero-title">به سیستم خوش آمدید</MudText>
                    <MudText Typo="Typo.body1" Class="hero-subtitle">برای دسترسی به تمام امکانات و ویژگی‌های پیشرفته سیستم وارد شوید</MudText>
                </div>
                
                <div class="hero-features">
                    <div class="hero-feature-item">
                        <div class="feature-icon-box">
                            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Medium" Class="feature-icon" />
                        </div>
                        <div class="feature-content">
                            <MudText Typo="Typo.body1" Class="feature-title">امنیت بالا</MudText>
                            <MudText Typo="Typo.body2" Class="feature-description">رمزگذاری پیشرفته و محافظت از داده‌ها</MudText>
                        </div>
                    </div>
                    
                    <div class="hero-feature-item">
                        <div class="feature-icon-box">
                            <MudIcon Icon="@Icons.Material.Filled.Speed" Size="Size.Medium" Class="feature-icon" />
                        </div>
                        <div class="feature-content">
                            <MudText Typo="Typo.body1" Class="feature-title">عملکرد سریع</MudText>
                            <MudText Typo="Typo.body2" Class="feature-description">پاسخگویی بالا و تجربه کاربری روان</MudText>
                        </div>
                    </div>
                    
                    <div class="hero-feature-item">
                        <div class="feature-icon-box">
                            <MudIcon Icon="@Icons.Material.Filled.Verified" Size="Size.Medium" Class="feature-icon" />
                        </div>
                        <div class="feature-content">
                            <MudText Typo="Typo.body1" Class="feature-title">مطمئن و قابل اعتماد</MudText>
                            <MudText Typo="Typo.body2" Class="feature-description">پشتیبانی 24/7 و خدمات حرفه‌ای</MudText>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Login Form -->
        <div class="login-form-section">
            <div class="login-form-card">
                <div class="form-card-glow"></div>
                <div class="form-card-pattern"></div>
                
                <div class="form-header-modern">
                    <div class="form-avatar-container">
                        <div class="form-avatar">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" Class="form-avatar-icon" />
                        </div>
                        <div class="form-avatar-rings">
                            <div class="avatar-ring-1"></div>
                            <div class="avatar-ring-2"></div>
                        </div>
                    </div>
                    <div class="form-header-text">
                        <MudText Typo="Typo.h4" Class="form-title">ورود به سیستم</MudText>
                        <MudText Typo="Typo.body2" Class="form-subtitle">لطفاً اطلاعات خود را وارد کنید</MudText>
                    </div>
                </div>

                <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin" Class="login-form-modern">
                    <DataAnnotationsValidator />
                    
                    <div class="form-input-group">
                        <MudTextField @bind-Value="_loginModel.Username" 
                                     Label="نام کاربری" 
                                     Variant="Variant.Outlined" 
                                     FullWidth="true"
                                     Required="true"
                                     RequiredError="نام کاربری الزامی است"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Person"
                                     Class="form-input-modern"
                                     InputType="InputType.Text"
                                     HelperText="نام کاربری خود را وارد کنید"
                                     HelperTextOnFocus="true" />
                    </div>

                    <div class="form-input-group">
                        <MudTextField @bind-Value="_loginModel.Password" 
                                     Label="رمز عبور" 
                                     Variant="Variant.Outlined" 
                                     InputType="@_passwordInputType" 
                                     FullWidth="true"
                                     Required="true"
                                     RequiredError="رمز عبور الزامی است"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Lock"
                                     Class="form-input-modern"
                                     HelperText="رمز عبور خود را وارد کنید"
                                     HelperTextOnFocus="true">
                            <AdornmentEnd>
                                <MudIconButton Icon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                              OnClick="TogglePasswordVisibility"
                                              Color="Color.Default"
                                              Class="password-toggle-btn" />
                            </AdornmentEnd>
                        </MudTextField>
                    </div>

                    <div class="form-options">
                        <MudCheckBox @bind-Checked="_rememberMe" 
                                    Label="مرا به خاطر بسپار" 
                                    Color="Color.Primary"
                                    Class="remember-checkbox" />
                        <MudButton Variant="Variant.Text" 
                                  Color="Color.Primary" 
                                  Href="/forgot-password"
                                  Class="forgot-password-link"
                                  Style="text-transform: none; font-weight: 600; font-size: 0.875rem; padding: 0;">
                            رمز عبور را فراموش کرده‌اید؟
                        </MudButton>
                    </div>

                    <MudButton ButtonType="ButtonType.Submit" 
                              Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              FullWidth="true"
                              Size="Size.Large"
                              Disabled="@_isLoading"
                              Class="login-submit-btn">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Class="me-2" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                            <MudText>در حال ورود...</MudText>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Login" Class="me-2" />
                            <MudText>ورود به سیستم</MudText>
                        }
                    </MudButton>
                </EditForm>

                <div class="form-divider">
                    <div class="divider-line"></div>
                    <MudText Typo="Typo.body2" Class="divider-text">یا</MudText>
                    <div class="divider-line"></div>
                </div>

                <div class="form-footer">
                    <MudText Typo="Typo.body2" Class="footer-text">حساب کاربری ندارید؟</MudText>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              FullWidth="true"
                              Href="/register"
                              StartIcon="@Icons.Material.Filled.PersonAdd"
                              Class="register-link-btn">
                        ایجاد حساب کاربری جدید
                    </MudButton>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginRequest _loginModel = new();
    private bool _isLoading = false;
    private bool _showPassword = false;
    private bool _rememberMe = false;
    private InputType _passwordInputType = InputType.Password;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        try
        {
            var result = await AuthService.LoginAsync(_loginModel);
            
            if (result != null && !string.IsNullOrEmpty(result.Token))
            {
                Snackbar.Add("ورود با موفقیت انجام شد", Severity.Success);
                
                if (AuthenticationStateProvider is CustomAuthenticationStateProvider authProvider)
                {
                    authProvider.NotifyUserAuthentication();
                }
                
                var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
                var returnUrl = uri.Query.TrimStart('?')
                    .Split('&')
                    .Select(p => p.Split('='))
                    .Where(p => p.Length == 2 && p[0] == "returnUrl")
                    .Select(p => Uri.UnescapeDataString(p[1]))
                    .FirstOrDefault();
                
                Navigation.NavigateTo(string.IsNullOrEmpty(returnUrl) ? "/" : returnUrl);
            }
            else
            {
                Snackbar.Add("نام کاربری یا رمز عبور اشتباه است", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"خطا در ورود: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
